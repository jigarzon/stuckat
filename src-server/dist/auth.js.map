{"version":3,"sources":["../src/auth.js"],"names":["passport","require","FacebookTokenStrategy","config","db","serializeUser","user","done","console","log","id","deserializeUser","dba","User","findOne","usr","use","clientID","appConfig","auth","facebook","clientId","clientSecret","accessToken","refreshToken","profile","Object","assign","firstName","name","givenName","lastName","familyName","email","emails","value","avatar","photos","_raw","_json","findOneAndUpdate","$set","upsert","result","module","exports","handleAuth","app","initialize","get","authenticate","req","res","status","json","send"],"mappings":"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","file":"auth.js","sourcesContent":["var passport = require('passport')\nvar FacebookTokenStrategy = require('passport-facebook-token')\nvar config = require('./configs')\nvar db = require('./db')\n\npassport.serializeUser(async function (user, done) {\n  console.log('Serializing', user.id)\n  done(null, user.id)\n})\n\npassport.deserializeUser(async function (id, done) {\n  var dba = await db.db()\n  console.log('deserializing', id)\n  try {\n    var usr = await dba.User.findOne({ id })\n    console.log('deserialized', usr)\n    done(null, usr)\n  } catch (e) {\n    done(e)\n  }\n})\n\npassport.use(\n  new FacebookTokenStrategy(\n    {\n      clientID: config.appConfig.auth.facebook.clientId,\n      clientSecret: config.appConfig.auth.facebook.clientSecret\n    },\n    async function (accessToken, refreshToken, profile, done) {\n      console.log('result login', accessToken, refreshToken, profile)\n      var dba = await db.db()\n      var user = Object.assign({}, profile)\n      user.firstName = user.name.givenName\n      user.lastName = user.name.familyName\n      user.email = user.emails[0].value\n      user.avatar = user.photos[0].value\n      delete user.photos\n      delete user.emails\n      delete user.name\n      delete user._raw\n      delete user._json\n      console.log('creating', user)\n      var result = await dba.User.findOneAndUpdate(\n        { id: profile.id },\n        { $set: user },\n        { upsert: true }\n      )\n      done(null, result.value)\n    }\n  )\n)\nmodule.exports.handleAuth = function ({ app }) {\n  app.use(passport.initialize())\n  app.get(\n    '/auth/facebook/callback',\n    passport.authenticate('facebook-token'),\n    (req, res) => {\n      if (req.user) {\n        res.status(200).json(req.user)\n      } else {\n        res.send(401)\n      }\n    }\n  )\n}\n"]}